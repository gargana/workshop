<!doctype html><html class=no-js lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta property="og:title" content="taskcat Workshop"><meta property="og:type" content="website"><meta property="og:url" content="https://aws-quickstart.github.io/taskcat/"><meta property="og:image" content="https://raw.githubusercontent.com/aws-quickstart/taskcat/master/assets/docs/images/favicon.png"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=generator content="Hugo 0.59.1"><meta name=description content="taskcat workshop"><meta name=author content="Tony Vattathil, Andrew Glenn, Shivansh Signh, Jay McConnell"><link rel="shortcut icon" href=../../images/favicon.png type=image/x-icon><link rel=icon href=../../images/favicon.png type=image/x-icon><title>Modify the template :: taskcat workshop</title><link href=../../css/nucleus.css?1574178766 rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link href=../../css/hybrid.css?1574178766 rel=stylesheet><link href=../../css/featherlight.min.css?1574178766 rel=stylesheet><link href=../../css/perfect-scrollbar.min.css?1574178766 rel=stylesheet><link href=../../css/auto-complete.css?1574178766 rel=stylesheet><link href=../../css/theme.css?1574178766 rel=stylesheet><link href=../../css/hugo-theme.css?1574178766 rel=stylesheet><link href=../../css/theme-blue.css?1574178766 rel=stylesheet><script src=../../js/jquery-2.x.min.js?1574178766></script><style type=text/css>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/amp/30_lab3/30_page2.html><nav id=sidebar><div id=header-wrapper><div id=header></div><div class=searchbox><label for=search-by><i class="fa fa-search"></i></label><input data-search-input id=search-by type=text placeholder=Search...>
<span data-search-clear><i class="fa fa-close"></i></span></div><script type=text/javascript src=../../js/lunr.min.js?1574178766></script><script type=text/javascript src=../../js/auto-complete.js?1574178766></script><script type=text/javascript>var baseurl='\/';</script><script type=text/javascript src=../../js/search.js?1574178766></script></div><div class=highlightable><ul class=topics><li data-nav-id=/00_pre.html title=Prerequisites class=dd-item><a href=../../00_pre.html>Prerequisites</a><ul><li data-nav-id=/amp/00_pre/00_page1.html title="Lab Enviornment" class=dd-item><a href=../../amp/00_pre/00_page1.html>Lab Enviornment</a></li></ul></li><li data-nav-id=/00_concepts.html title="Getting Started" class=dd-item><a href=../../00_concepts.html>Getting Started</a><ul><li data-nav-id=/amp/00_concepts/00_page1.html title="Config hierarchy" class=dd-item><a href=../../amp/00_concepts/00_page1.html>Config hierarchy</a></li><li data-nav-id=/amp/00_concepts/00_page2.html title="Parameter Overrides" class=dd-item><a href=../../amp/00_concepts/00_page2.html>Parameter Overrides</a></li></ul></li><li data-nav-id=/10_lab1.html title="Lab 1" class=dd-item><a href=../../10_lab1.html>Lab 1</a><ul><li data-nav-id=/amp/10_lab1/10_page2.html title="Add a (Project Level) config" class=dd-item><a href=../../amp/10_lab1/10_page2.html>Add a (Project Level) config</a></li><li data-nav-id=/amp/10_lab1/10_page3.html title="- Define project section" class=dd-item><a href=../../amp/10_lab1/10_page3.html>- Define project section</a></li><li data-nav-id=/amp/10_lab1/10_page4.html title="- Defining tests" class=dd-item><a href=../../amp/10_lab1/10_page4.html>- Defining tests</a></li><li data-nav-id=/amp/10_lab1/10_page5.html title="- Define regions" class=dd-item><a href=../../amp/10_lab1/10_page5.html>- Define regions</a></li><li data-nav-id=/amp/10_lab1/10_page6.html title="- Define parameters" class=dd-item><a href=../../amp/10_lab1/10_page6.html>- Define parameters</a></li><li data-nav-id=/amp/10_lab1/10_page8.html title="Lambda packaging" class=dd-item><a href=../../amp/10_lab1/10_page8.html>Lambda packaging</a></li><li data-nav-id=/amp/10_lab1/10_page7.html title="Execute a taskcat test" class=dd-item><a href=../../amp/10_lab1/10_page7.html>Execute a taskcat test</a></li><li data-nav-id=/amp/10_lab1/10_page9.html title="View test results" class=dd-item><a href=../../amp/10_lab1/10_page9.html>View test results</a></li></ul></li><li data-nav-id=/20_lab2.html title="Lab 2" class=dd-item><a href=../../20_lab2.html>Lab 2</a><ul><li data-nav-id=/amp/20_lab2/20_page1.html title="Create Psuedo Parameters" class=dd-item><a href=../../amp/20_lab2/20_page1.html>Create Psuedo Parameters</a></li><li data-nav-id=/amp/20_lab2/20_page2.html title="Execute a taskcat test" class=dd-item><a href=../../amp/20_lab2/20_page2.html>Execute a taskcat test</a></li><li data-nav-id=/amp/20_lab2/20_page3.html title="Check Template Outputs" class=dd-item><a href=../../amp/20_lab2/20_page3.html>Check Template Outputs</a></li></ul></li><li data-nav-id=/30_lab3.html title="Lab 3" class="dd-item
parent"><a href=../../30_lab3.html>Lab 3</a><ul><li data-nav-id=/amp/30_lab3/30_page1.html title="Add additional regions &amp; test" class=dd-item><a href=../../amp/30_lab3/30_page1.html>Add additional regions &amp; test</a></li><li data-nav-id=/amp/30_lab3/30_page2.html title="Modify the template" class="dd-item active"><a href=../../amp/30_lab3/30_page2.html>Modify the template</a></li><li data-nav-id=/amp/30_lab3/30_page3.html title="Test again &amp; verify!" class=dd-item><a href=../../amp/30_lab3/30_page3.html>Test again &amp; verify!</a></li></ul></li><li data-nav-id=/40_lab4.html title="Lab 4" class=dd-item><a href=../../40_lab4.html>Lab 4</a><ul><li data-nav-id=/amp/40_lab4/40_page1.html title="Run test with no-delete" class=dd-item><a href=../../amp/40_lab4/40_page1.html>Run test with no-delete</a></li></ul></li><li data-nav-id=/50_lab5.html title="Lab 5" class=dd-item><a href=../../50_lab5.html>Lab 5</a><ul><li data-nav-id=/amp/50_lab5/1_page.html title="Initialize Git repo" class=dd-item><a href=../../amp/50_lab5/1_page.html>Initialize Git repo</a></li><li data-nav-id=/amp/50_lab5/10_page.html title="Deploy CI/CD pipeline" class=dd-item><a href=../../amp/50_lab5/10_page.html>Deploy CI/CD pipeline</a></li><li data-nav-id=/amp/50_lab5/20_page.html title="View test and code promotion" class=dd-item><a href=../../amp/50_lab5/20_page.html>View test and code promotion</a></li></ul></li><li data-nav-id=/60_lab6.html title=Bonus class=dd-item><a href=../../60_lab6.html>Bonus</a></li></ul><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://taskcat.github.io/workshop/><i class="fas fa-bookmark"></i>taskcat documentation</a></li><li><a class=padding href=https://github.com/aws-quickstart/taskcat><i class="fab fa-github"></i>aws-quickstart/taskcat</a></li></ul></section><section id=footer><left><a class=link href=https://aws-quickstart.github.io/taskcat/><img src=https://raw.githubusercontent.com/aws-quickstart/taskcat/master/assets/docs/images/logo.png></a><h5>Latest Version</h5><a href=https://badge.fury.io/py/taskcat><img alt="PyPI version" src=https://badge.fury.io/py/taskcat.svg></a></p><h5>Repo Status</h5><a class=github-button href=https://github.com/aws-quickstart aria-label="Follow @taskcat on GitHub">Follow @aws-quickstart</a><p><a class=github-button href=https://github.com/aws-quickstart/taskcat/subscription data-icon=octicon-eye aria-label="Watch aws-quickstart/taskcat on GitHub">Watch</a><p><a class=github-button href=https://github.com/aws-quickstart/taskcat data-icon=octicon-star data-show-count=true aria-label="Star on GitHub">Star</a><p><h5 class=copyright>&copy; 2019 Amazon Web Services, Inc. or its Affiliates. All rights reserved.<h5></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fa fa-bars"></i></a></span><span id=toc-menu><i class="fa fa-list-alt"></i></span><span class=links><a href=../../amp/>Taskcat Workshop</a> > <a href=../../30_lab3.html>Lab 3</a> > Modify the template</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#making-our-template-multi-region>Making our template multi-region</a></li></ul></li></ul></nav></div></div></div></div><div id=body-inner><h1>Modify the template</h1><h2 id=making-our-template-multi-region>Making our template multi-region</h2><p>There are multiple potential strategies to deal with resources that require the content
in S3 to be in the same region as the stack. In this example we will add a resource to
the stack that copies the Lambda zip from the bucket in us-east-1 to the stack region
before creating the lambda.</p><ul><li><p>In VSCode, edit the <code>cfn_project/templates/lab3.template.yaml</code> file. We&rsquo;ll be adding
the following snippet to the <em>Resources</em> section of the template.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>CopyZipsTemplate:
Type: AWS::CloudFormation::Stack
Properties:
  TemplateURL: !Sub <span style=color:#e6db74>&#34;https://${S3BucketName}.${AWS::Region}.amazonaws.com/${S3KeyPrefix}templates/copy-zips.template.yaml&#34;</span>
  Parameters:
    S3BucketName: !Ref S3BucketName
    S3KeyPrefix: !Ref S3KeyPrefix
    SourceObjects: <span style=color:#e6db74>&#34;lambda_functions/packages/GenRandom/lambda.zip&#34;</span></code></pre></div></li></ul><p>This child stack contains a Lambda backed custom resource that takes the SourceObjects
passed in and copies it to a new bucket in the same region as the stack. The outputs
return the name of the new bucket, that we will use in the Code property of our
<strong>GenRandomLambda</strong> resource.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  GenRandomLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Lambda creates simple random string
      Handler: lambda_function.handler
      Runtime: python3<span style=color:#ae81ff>.7</span>
      Role: !GetAtt <span style=color:#e6db74>&#39;LambdaExecutionRole.Arn&#39;</span>
      Timeout: <span style=color:#ae81ff>300</span>
      Code:
        S3Bucket: !GetAtt <span style=color:#e6db74>&#39;CopyZipsTemplate.Outputs.LambdaZipsBucket&#39;</span>
        S3Key: !Sub <span style=color:#e6db74>&#39;${S3KeyPrefix}lambda_functions/packages/GenRandom/lambda.zip&#39;</span></code></pre></div><p>The full template should reflect the following:</p><ul><li><p>Feel free to copy and paste!</p><pre><code>AWSTemplateFormatVersion: 2010-09-09
Parameters:
  S3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription: &gt;-
      Bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: &gt;-
      S3 bucket name for assets. Bucket name can
      include numbers, lowercase letters, uppercase letters, and hyphens (-). It
      cannot start or end with a hyphen (-).
    Type: String
  S3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription: &gt;-
      Can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/).
    Default: 'cfn-project/'
    Description: &gt;-
      S3 key prefix where assets are located should end with forward slash (/).
    Type: String
Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: &quot;/&quot;
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource: arn:aws:logs:*:*:*
  GenRandomLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Lambda creates simple random string
      Handler: lambda_function.handler
      Runtime: python3.7
      Role: !GetAtt 'LambdaExecutionRole.Arn'
      Timeout: 300
      Code:
        S3Bucket: !Ref 'S3BucketName'
        S3Key: !Sub '${S3KeyPrefix}lambda_functions/packages/GenRandom/lambda.zip'
  StringGenerator:
    Type: Custom::RandomString
    Properties:
      ServiceToken: !GetAtt GenRandomLambda.Arn
      Length: 12
  CopyZipsTemplate:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub &quot;https://${S3BucketName}.${AWS::Region}.amazonaws.com/${S3KeyPrefix}templates/copy-zips.template.yaml&quot;
      Parameters:
        S3BucketName: !Ref S3BucketName
        S3KeyPrefix: !Ref S3KeyPrefix
        SourceObjects: &quot;lambda_functions/packages/GenRandom/lambda.zip&quot;
Outputs:
  GeneratedRandomString:
    Description: Generated Random String
    Value: !GetAtt StringGenerator.RandomString
  LicenseToken:
    Description:  LicenseToken passed in via overrides
    Value: !Ref LicenseToken
  AvailabilityZones:
    Description:  AvailabilityZones injected via $[taskcat_genaz_3] psuedo-parameter
    Value:  !Join [ ',', !Ref 'AvailabilityZones' ]
</code></pre></li></ul><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=../../amp/30_lab3/30_page1.html title="Add additional regions &amp; test"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=../../amp/30_lab3/30_page3.html title="Test again &amp; verify!" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../../js/clipboard.min.js?1574178766></script><script src=../../js/perfect-scrollbar.min.js?1574178766></script><script src=../../js/perfect-scrollbar.jquery.min.js?1574178766></script><script src=../../js/jquery.sticky.js?1574178766></script><script src=../../js/featherlight.min.js?1574178766></script><script src=../../js/html5shiv-printshiv.min.js?1574178766></script><script src=../../js/highlight.pack.js?1574178766></script><script>hljs.initHighlightingOnLoad();</script><script src=../../js/modernizr.custom.71422.js?1574178766></script><script src=../../js/learn.js?1574178766></script><script src=../../js/hugo-learn.js?1574178766></script><link href=../../mermaid/mermaid.css?1574178766 type=text/css rel=stylesheet><script src=../../mermaid/mermaid.js?1574178766></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>